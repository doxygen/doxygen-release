on:
  workflow_dispatch:

name: Create Doxygen Release

permissions:
  contents: read

env:
  BUILD_TYPE: Release

jobs:

#===============================================================
# LLVM JOB
#===============================================================
  build-llvm:
    name: LLVM (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            cpu: intel
            platform: linux
            extension: ""
            archive_format: tar.gz
          - os: windows-latest
            cpu: intel
            platform: windows
            extension: .exe
            archive_format: zip
          - os: macos-15
            cpu: arm
            platform: macos
            extension: ""
            archive_format: tar.gz
          - os: macos-15-intel
            cpu: intel
            platform: macos
            extension: ""
            archive_format: tar.gz
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

#------------------------------------- setup Linux environment for LLVM

    - name: Install dependencies (Linux)
      if: matrix.platform == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          git \
          python3 \
          python3-pip \
          zlib1g-dev \
          libedit-dev \
          libffi-dev \
          libxml2-dev \
          libtinfo-dev
      shell: bash

#------------------------------------- setup Windows environment for LLVM
#
    - name: Install dependencies (Windows)
      if: matrix.platform == 'windows'
      run: |
        choco install ninja
      shell: bash

#------------------------------------- setup macOS environment for LLVM

    - name: Install dependencies (macOS)
      if: matrix.platform == 'macos'
      run: |
        brew install cmake ninja
      shell: bash

#------------------------------------- determine LLVM version to use

    - name: Get latest LLVM release tag
      id: llvm-version
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -euo pipefail
        echo "GITHUB_TOKEN present: ${GITHUB_TOKEN:+yes}"
        # Retry loop with exponential backoff
        attempts=5
        sleep_for=2
        for i in $(seq 1 $attempts); do
          echo "Attempt $i..."
          resp=$(curl -sS -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github.v3+json" "https://api.github.com/repos/llvm/llvm-project/releases/latest" ) || true
          http_code=$(echo "$resp" | jq -r '. | if has("message") then "error" else "ok" end')
          tag=$(echo "$resp" | jq -r '.tag_name // empty')
          if [ -n "$tag" ]; then
            LATEST_TAG="$tag"
            break
          fi
          echo "No tag found. API response (truncated):"
          echo "$resp" | jq -C '.' | sed -n '1,200p'
          echo "Sleeping $sleep_for seconds before retry..."
          sleep $sleep_for
          sleep_for=$((sleep_for * 2))
        done

        if [ -z "${LATEST_TAG:-}" ]; then
          echo "Error: Could not fetch LLVM release tag; last response:"
          echo "$resp" | jq -C '.' || echo "$resp"
          exit 1
        fi

        echo "Latest LLVM release: $LATEST_TAG"
        echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT
        VERSION=${LATEST_TAG#llvmorg-}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
      shell: bash

#------------------------------------- get LLVM sources to build

    - name: Cache LLVM source
      id: cache-llvm-source
      uses: actions/cache@v4
      with:
        path: llvm-project
        key: llvm-source-${{ steps.llvm-version.outputs.tag }}-${{ matrix.os }}

    - name: Download LLVM source code
      if: steps.cache-llvm-source.outputs.cache-hit != 'true'
      run: |
        echo "Downloading LLVM ${{ steps.llvm-version.outputs.tag }}"
        git clone --depth 1 --branch ${{ steps.llvm-version.outputs.tag }} https://github.com/llvm/llvm-project.git
        if [ ! -d "llvm-project/llvm" ]; then
          echo "Error: LLVM source download failed or directory structure is incorrect"
          exit 1
        fi
        echo "LLVM source downloaded successfully"
      shell: bash

#------------------------------------- configure LLVM

    - name: Configure CMake for LLVM (Linux/macOS)
      if: matrix.platform != 'windows'
      run: |
        # Verify LLVM source directory exists
        if [ ! -d "llvm-project/llvm" ]; then
          echo "Error: LLVM source directory not found"
          exit 1
        fi
        mkdir -p llvm-project/build
        cd llvm-project/build
        cmake ../llvm \
          -G "Unix Makefiles" \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/llvm-install \
          -DLLVM_ENABLE_PROJECTS="clang;lld" \
          -DLIBCLANG_BUILD_STATIC=ON \
          -DLLVM_ENABLE_OCAMLDOC=OFF \
          -DLLVM_ENABLE_LTO=OFF \
          -DLLVM_ENABLE_WARNINGS=OFF \
          -DLLVM_ENABLE_Z3_SOLVER=OFF \
          -DLLVM_ENABLE_ZSTD=OFF \
          -DLLVM_ENABLE_BINDING=OFF \
          -DLLVM_ENABLE_LIBXML2=OFF \
          -DLLVM_ENABLE_LIBEDIT=OFF \
          -DLLVM_ENABLE_ASSERTIONS=OFF \
          -DLLVM_INCLUDE_BENCHMARKS=OFF \
          -DLLVM_INCLUDE_TESTS=OFF \
          -DLLVM_INCLUDE_EXAMPLES=OFF \
          -DLLVM_TOOL_REMARKS_SHLIB_BUILD=OFF \
          -DLLVM_PARALLEL_LINK_JOBS=1 \
          ${{ matrix.cmake_args }}
          cmake --build . --parallel 2
          cmake --install .
      shell: bash

    - name: Set up MSVC dev command prompt (Windows)
      if: matrix.platform == 'windows'
      uses: ilammy/msvc-dev-cmd@v1

    - name: Configure CMake for LLVM (Windows)
      if: matrix.platform == 'windows'
      run: |
        mkdir llvm-project
        mkdir llvm-project\build
        cd llvm-project\build
        cmake ..\llvm ^
          -G Ninja ^
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} ^
          -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}\llvm-install ^
          -DLLVM_ENABLE_PROJECTS="clang;lld" ^
          -DLIBCLANG_BUILD_STATIC=ON ^
          -DLLVM_ENABLE_OCAMLDOC=OFF ^
          -DLLVM_ENABLE_LTO=OFF ^
          -DLLVM_ENABLE_WARNINGS=OFF ^
          -DLLVM_ENABLE_Z3_SOLVER=OFF ^
          -DLLVM_ENABLE_ZSTD=OFF ^
          -DLLVM_ENABLE_ZLIB=OFF ^
          -DLLVM_ENABLE_BINDING=OFF ^
          -DLLVM_ENABLE_LIBXML2=OFF ^
          -DLLVM_ENABLE_LIBEDIT=OFF ^
          -DLLVM_ENABLE_ASSERTIONS=OFF ^
          -DLLVM_INCLUDE_BENCHMARKS=OFF ^
          -DLLVM_INCLUDE_TESTS=OFF ^
          -DLLVM_INCLUDE_EXAMPLES=OFF ^
          -DLLVM_TOOL_REMARKS_SHLIB_BUILD=OFF ^
          -DLLVM_PARALLEL_LINK_JOBS=1 ^
          -DLLVM_USE_CRT_RELEASE=MT ^
          -DLLVM_TARGETS_TO_BUILD="X86;AArch64" ^
          -DCMAKE_MSVC_RUNTIME_LIBRARY=MultiThreaded
        cmake --build . --parallel 2
        cmake --install .
      shell: cmd

#------------------------------------- check LLVM build results

    - name: Verify static build
      run: |
        echo "Checking libclang static library..."
        if [ "${{ matrix.platform }}" == "windows" ]; then
          win_search_dir="${{ github.workspace }}/llvm-install"
          win_search_dir="${search_dir//\\//}"
          find $win_search_dir -name "libclang*.lib" -o -name "clang*.lib" | head -10
        else
          find ${{ github.workspace }}/llvm-install -name "libclang*.a" | head -10
        fi
      shell: bash

#------------------------------------- create LLVM artifacts to upload

    - name: Create build artifact (Linux/macOS)
      if: matrix.platform != 'windows'
      run: |
        cd ${{ github.workspace }}
        tar -czf llvm-static-${{ steps.llvm-version.outputs.version }}-${{ matrix.os }}.tar.gz -C llvm-install .
      shell: bash

    - name: Create build artifact (Windows)
      if: matrix.platform == 'windows'
      run: |
        Compress-Archive -Path 'llvm-install\\*' -DestinationPath 'llvm-static-${{ steps.llvm-version.outputs.version }}-${{ matrix.os }}.zip' -Force
      shell: pwsh

#------------------------------------- upload LLVM artifacts

    - name: Upload LLVM static build
      uses: actions/upload-artifact@v4
      with:
        name: llvm-static-${{ steps.llvm-version.outputs.version }}-${{ matrix.os }}
        path: llvm-static-${{ steps.llvm-version.outputs.version }}-${{ matrix.os }}.${{ matrix.archive_format }}
        retention-days: 30

#===============================================================
# Xapian JOB
#===============================================================

  build-xapian:
    name: Xapian (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            cpu: intel
            platform: linux
            extension: ""
            archive_format: tar.gz
          - os: windows-latest
            cpu: intel
            platform: windows
            extension: .exe
            archive_format: zip
          - os: macos-15
            cpu: arm
            platform: macos
            extension: ""
            archive_format: tar.gz
          - os: macos-15-intel
            cpu: intel
            platform: macos
            extension: ""
            archive_format: tar.gz

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

#------------------------------------- setup Linux environment for Xapian

      - name: Install dependencies (Linux)
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libmagic-dev \
            build-essential \
            autoconf \
            automake \
            libtool \
            git \
            zlib1g-dev \
            uuid-dev
        shell: bash

#------------------------------------- setup Windows environment for Xapian

      - name: Install dependencies (Windows)
        if: matrix.platform == 'windows'
        run: |
          choco install wget -y
        shell: bash

      - name: Set up MSVC dev command prompt (Windows)
        if: matrix.platform == 'windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Download zlib (Windows)
        if: matrix.platform == 'windows'
        run: |
          curl -L -o zlib.tgz https://zlib.net/zlib-1.3.1.tar.gz
          tar zxvf zlib.tgz

      - name: Build zlib (Windows)
        if: matrix.platform == 'windows'
        shell: cmd
        run: |
          cd zlib-1.3.1
          @rem nmake -f win32\Makefile.msc LOC="-MT" all
          nmake -f win32\Makefile.msc LOC="-MT" zlib.lib

      - name: Install MSYS2 (Windows)
        uses: msys2/setup-msys2@v2
        if: matrix.platform == 'windows'
        with:
          update: true
          install: >-
            base-devel
            mingw-w64-x86_64-toolchain
            autoconf
            automake
            libtool
            jq

#------------------------------------- setup macOS environment for Xapian

      - name: Install dependencies (macOS)
        if: matrix.platform == 'macos'
        run: |
          brew install autoconf automake libtool libmagic
        shell: bash

#------------------------------------- determine version of Xapian to use

      - name: Get latest Xapian stable release tag
        id: xapian-version
        run: |
          VERSION="1.4.29"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"
        shell: bash

#------------------------------------- download Xapian sources to build

      #- name: Cache Xapian source
      #  id: cache-xapian-source
      #  uses: actions/cache@v4
      #  with:
      #    path: xapian
      #    key: xapian-core-${{ steps.xapian-version.outputs.version }}-${{ matrix.os }}.tar.xz

      - name: Download Xapian source code
        #if: steps.cache-xapian-source.outputs.cache-hit != 'true'
        run: |
          VERSION="${{ steps.xapian-version.outputs.version }}"
          echo "Downloading Xapian $VERSION"
          mkdir xapian
          cd xapian
          wget https://oligarchy.co.uk/xapian/$VERSION/xapian-core-$VERSION.tar.xz
          tar -Jxf xapian-core-$VERSION.tar.xz
          rm xapian-core-$VERSION.tar.xz
          echo "Xapian source downloaded successfully"
        shell: bash

#------------------------------------- configure Xapian build for Linux/macOS

      - name: Configure Xapian (Linux/macOS)
        if: matrix.platform != 'windows'
        run: |
          VERSION="${{ steps.xapian-version.outputs.version }}"
          cd xapian/xapian-core-$VERSION
          ./configure \
            --prefix=${{ github.workspace }}/xapian-install \
            --enable-static=yes \
            --enable-shared=no \
            --disable-documentation \
            ${{ matrix.configure_args }}
        shell: bash

#------------------------------------- configure Xapian build for Windows

      - name: Write configure script (Windows)
        if: matrix.platform == 'windows'
        run: |
          VERSION="${{ steps.xapian-version.outputs.version }}"
          cd xapian/xapian-core-$VERSION
          cat <<- 'EOF' > run_me.sh
          export CC="cl -nologo"
          export CXX="./compile cl -nologo"
          export CXXFLAGS="-EHsc"
          export AR="lib"
          export LD="link"
          export NM="dumpbin"
          export CPPFLAGS="-I../../zlib-1.3.1"
          export LDFLAGS="-I../../zlib-1.3.1"
          export PREFIX_UNIX="$(cygpath $PREFIX)"
          echo "prefix=$PREFIX_UNIX"
          ./configure --enable-static=yes --enable-shared=no --prefix=$PREFIX_UNIX
          make
          make install
          EOF
          chmod 755 run_me.sh
          echo "===="
          cat run_me.sh
          echo "===="
        shell: bash

      - name: Configure and Build Xapian (Windows)
        if: matrix.platform == 'windows'
        shell: cmd
        run: |
          @echo on
          set VERSION=${{ steps.xapian-version.outputs.version }}
          cd xapian\xapian-core-%VERSION%
          set PATH=C:\msys64\usr\bin;%PATH%
          set LIB=..\..\zlib-1.3.1;%LIB%
          set PREFIX=${{ github.workspace }}\xapian-install
          set MSYS2_PATH_TYPE=inherit
          bash -c "./run_me.sh"

      - name: Build Xapian (Linux/macOS)
        if: matrix.platform != 'windows'
        run: |
          VERSION="${{ steps.xapian-version.outputs.version }}"
          cd xapian/xapian-core-$VERSION
          make
          make install
        shell: bash

#------------------------------------- verify Xapian build results

      - name: Verify static build
        run: |
          echo "Checking Xapian static library..."
          cd xapian
          if [ "${{ matrix.platform }}" == "windows" ]; then
            find "$(cygpath "${{ github.workspace }}")/xapian-install" -name "*.lib" | head -10
          else
            find ${{ github.workspace }}/xapian-install -name "*.a" | head -10
            nm -C ${{ github.workspace }}/xapian-install/lib/libxapian.a  | grep " U " | sort | uniq
          fi
        shell: bash

#------------------------------------- create Xapian build artifacts to upload

      - name: Create build artifact (Linux/macOS)
        if: matrix.platform != 'windows'
        run: |
          cd ${{ github.workspace }}
          tar -czf xapian-static-${{ steps.xapian-version.outputs.version }}-${{ matrix.os }}.tar.gz -C xapian-install .
        shell: bash

      - name: Create build artifact (Windows)
        if: matrix.platform == 'windows'
        run: |
          Compress-Archive -Path 'xapian-install\\*' -DestinationPath 'xapian-static-${{ steps.xapian-version.outputs.version }}-${{ matrix.os }}.zip' -Force
        shell: pwsh

#------------------------------------- upload Xapian build artifacts

      - name: Upload Xapian static build
        uses: actions/upload-artifact@v4
        with:
          name: xapian-static-${{ steps.xapian-version.outputs.version }}-${{ matrix.os }}
          path: xapian-static-${{ steps.xapian-version.outputs.version }}-${{ matrix.os }}.${{ matrix.archive_format }}
          retention-days: 30

#===============================================================
# Qt6 JOB
#===============================================================

  build-qt6:
    name: Qt6 (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            cpu: intel
            platform: linux
            extension: ""
            archive_format: tar.gz
          - os: windows-latest
            cpu: intel
            platform: windows
            extension: .exe
            archive_format: zip
          - os: macos-15
            cpu: arm
            platform: macos
            extension: ""
            archive_format: tar.gz
          - os: macos-15-intel
            cpu: intel
            platform: macos
            extension: ""
            archive_format: tar.gz
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

#------------------------------------- setup Linux environment for Qt6

    - name: Install dependencies (Linux)
      if: matrix.platform == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          libfontconfig1-dev \
          libfreetype6-dev \
          libx11-dev \
          libx11-xcb-dev \
          libxext-dev \
          libxfixes-dev \
          libxi-dev \
          libxrender-dev \
          libxcb1-dev \
          libxcb-cursor-dev \
          libxcb-glx0-dev \
          libxcb-keysyms1-dev \
          libxcb-image0-dev \
          libxcb-shm0-dev \
          libxcb-icccm4-dev \
          libxcb-sync-dev \
          libxcb-xfixes0-dev \
          libxcb-shape0-dev \
          libxcb-randr0-dev \
          libxcb-render-util0-dev \
          libxcb-util-dev \
          libxcb-xinerama0-dev \
          libxcb-xkb-dev \
          libxkbcommon-dev \
          libxkbcommon-x11-dev \
          libgl1-mesa-dev \
          libglu1-mesa-dev
      shell: bash

#------------------------------------- setup Windows environment for Qt6

    - name: Install dependencies (Windows)
      if: matrix.platform == 'windows'
      run: |
        choco install ninja
      shell: bash

    - name: Set up MSVC dev command prompt (Windows)
      if: matrix.platform == 'windows'
      uses: ilammy/msvc-dev-cmd@v1

#------------------------------------- setup macOS environment for Qt6

    - name: Install dependencies (macOS)
      if: matrix.platform == 'macos'
      run: |
        brew install cmake ninja
        which ninja
      shell: bash

#------------------------------------- determine Qt6 version to use

    - name: Set Qt6 version
      id: qt6-version
      run: |
        # Using a fixed Qt6 version for stability
        # Update this version when a new Qt6 is released
        VERSION="6.10.0"
        echo "Qt6 version: $VERSION"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
      shell: bash

#------------------------------------- download Qt6 sources

    #- name: Cache Qt6 source
    #  id: cache-qt6-source
    #  uses: actions/cache@v4
    #  with:
    #    path: qt6-source
    #    key: qt6-source-${{ steps.qt6-version.outputs.version }}-${{ matrix.os }}

    - name: Download Qt6 source code
      #if: steps.cache-qt6-source.outputs.cache-hit != 'true'
      run: |
        echo "Downloading Qt6 ${{ steps.qt6-version.outputs.version }}"
        VERSION="${{ steps.qt6-version.outputs.version }}"
        MAJOR_MINOR=$(echo "$VERSION" | cut -d. -f1-2)

        # Download qtbase
        mkdir -p qt6-source
        cd qt6-source

        echo "Downloading qtbase..."
        curl -L -o qtbase.tar.xz "https://download.qt.io/official_releases/qt/$MAJOR_MINOR/$VERSION/submodules/qtbase-everywhere-src-$VERSION.tar.xz"
        tar -xf qtbase.tar.xz
        mv qtbase-everywhere-src-$VERSION qtbase
        rm qtbase.tar.xz

        echo "Downloading qtsvg..."
        curl -L -o qtsvg.tar.xz "https://download.qt.io/official_releases/qt/$MAJOR_MINOR/$VERSION/submodules/qtsvg-everywhere-src-$VERSION.tar.xz"
        tar -xf qtsvg.tar.xz
        mv qtsvg-everywhere-src-$VERSION qtsvg
        rm qtsvg.tar.xz

        if [ ! -d "qtbase" ] || [ ! -d "qtsvg" ]; then
          echo "Error: Qt6 source download failed or directory structure is incorrect"
          exit 1
        fi
        echo "Qt6 source downloaded successfully"
      shell: bash

#------------------------------------- configure Qt6 for building

    - name: Configure CMake for Qt6 Base (Windows)
      if: matrix.platform == 'windows'
      run: |
        cd qt6-source\qtbase
        call configure.bat -static -static-runtime -release -prefix ${{ github.workspace }}\qt6-install -platform win32-msvc -qt-zlib -qt-pcre -qt-libpng -qt-libjpeg -qt-freetype -opengl desktop -sql-sqlite -sql-odbc -no-openssl -opensource -confirm-license -make libs -nomake tools -nomake tests
        cmake --build . --parallel
        cmake --install .
      shell: cmd

    - name: Configure CMake for Qt6 Base (Linux)
      if: matrix.platform == 'linux'
      run: |
        cd qt6-source/qtbase
        ./configure -static -static-runtime -release -prefix ${{ github.workspace }}/qt6-install -platform linux-g++-64 -qt-zlib -qt-pcre -qt-libpng -qt-libjpeg -qt-freetype -opengl desktop -sql-sqlite -no-openssl -opensource -confirm-license -make libs -nomake tools -nomake tests
        cmake --build . --parallel
        cmake --install .
      shell: bash

    - name: Configure CMake for Qt6 Base (macOS)
      if: matrix.platform == 'macos'
      run: |
        cd qt6-source/qtbase
        ./configure -static -static-runtime -release -prefix ${{ github.workspace }}/qt6-install -platform macx-clang -qt-zlib -qt-pcre -qt-libpng -qt-libjpeg -qt-freetype -opengl desktop -sql-sqlite -no-openssl -opensource -confirm-license -make libs -nomake tools -nomake tests
        cmake --build . --parallel
        cmake --install .
      shell: bash

    - name: Configure CMake for Qt6 SVG (Windows)
      if: matrix.platform == 'windows'
      run: |
        cd qt6-source\qtsvg
        call ${{ github.workspace }}\qt6-install\bin\qt-configure-module.bat .
        cmake --build . --parallel
        cmake --install .
      shell: cmd

    - name: Configure CMake for Qt6 SVG (Linux/macOS)
      if: matrix.platform != 'windows'
      run: |
        cd qt6-source/qtsvg
        ${{ github.workspace }}/qt6-install/bin/qt-configure-module .
        cmake --build . --parallel
        cmake --install .
      shell: bash

#------------------------------------- verify Qt6 build results

    - name: Verify static build
      run: |
        echo "Checking Qt6 static libraries..."
        if [ "${{ matrix.platform }}" == "windows" ]; then
          win_search_dir="${{ github.workspace }}/qt6-install"
          win_search_dir="${win_search_dir//\\//}"
          find $win_search_dir -name "Qt6*.lib" | head -10
        else
          find ${{ github.workspace }}/qt6-install -name "libQt6*.a" | head -10
        fi
      shell: bash

#------------------------------------- create Qt6 build artifacts to upload

    - name: Create build artifact (Linux/macOS)
      if: matrix.platform != 'windows'
      run: |
        cd ${{ github.workspace }}
        tar -czf qt6-static-${{ steps.qt6-version.outputs.version }}-${{ matrix.os }}.tar.gz -C qt6-install .
      shell: bash

    - name: Create build artifact (Windows)
      if: matrix.platform == 'windows'
      run: |
        Compress-Archive -Path 'qt6-install\\*' -DestinationPath 'qt6-static-${{ steps.qt6-version.outputs.version }}-${{ matrix.os }}.zip' -Force
      shell: pwsh

#------------------------------------- upload the Qt6 build artifacts

    - name: Upload Qt6 static build
      uses: actions/upload-artifact@v4
      with:
        name: qt6-static-${{ steps.qt6-version.outputs.version }}-${{ matrix.os }}
        path: qt6-static-${{ steps.qt6-version.outputs.version }}-${{ matrix.os }}.${{ matrix.archive_format }}
        retention-days: 30

#===============================================================
# DOXYGEN JOB
#===============================================================
  build-doxygen:
    name: Doxygen (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: [build-llvm, build-xapian, build-qt6]
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            cpu: intel
            platform: linux
            extension: ""
            archive_format: tar.gz
          - os: windows-latest
            cpu: intel
            platform: windows
            extension: .exe
            archive_format: zip
          - os: macos-15
            cpu: arm
            platform: macos
            extension: ""
            archive_format: tar.gz
          - os: macos-15-intel
            cpu: intel
            platform: macos
            extension: ""
            archive_format: tar.gz    

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

#------------------------------------- setup Linux environment

    - name: Install dependencies (Linux)
      if: matrix.platform == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          git \
          python3 \
          python3-pip \
          zlib1g-dev \
          libedit-dev \
          libffi-dev \
          libxml2-dev \
          libtinfo-dev \
          flex \
          bison \
          libfontconfig1-dev \
          libfreetype6-dev \
          libx11-dev \
          libx11-xcb-dev \
          libxext-dev \
          libxfixes-dev \
          libxi-dev \
          libxrender-dev \
          libxcb1-dev \
          libxcb-cursor-dev \
          libxcb-glx0-dev \
          libxcb-keysyms1-dev \
          libxcb-image0-dev \
          libxcb-shm0-dev \
          libxcb-icccm4-dev \
          libxcb-sync-dev \
          libxcb-xfixes0-dev \
          libxcb-shape0-dev \
          libxcb-randr0-dev \
          libxcb-render-util0-dev \
          libxcb-util-dev \
          libxcb-xinerama0-dev \
          libxcb-xkb-dev \
          libxkbcommon-dev \
          libxkbcommon-x11-dev \
          libgl1-mesa-dev \
          libglu1-mesa-dev \
          uuid-dev \
          texlive \
          texlive-latex-recommended \
          texlive-extra-utils \
          texlive-latex-extra \
          texlive-font-utils \
          ghostscript \
          graphviz
      shell: bash

#------------------------------------- setup Windows environment

    - name: Install dependencies (Windows)
      if: matrix.platform == 'windows'
      run: |
        choco install ninja winflexbison3 ghostscript graphviz.portable innosetup
      shell: bash

    - name: Install MikTeX (Windows)
      if: matrix.platform == 'windows'
      uses: nick-invision/retry@v3
      with:
        timeout_minutes: 15
        max_attempts: 5
        retry_wait_seconds: 60
        command: |
          choco install miktex --debug --verbose --no-progress --params "/Set:basic" -y
          if ($?) { echo "C:\Program Files\MiKTeX\miktex\bin\x64" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 }

    - name: Configure MikTeX (Windows)
      if: matrix.platform == 'windows'
      run: |
        miktex --admin --verbose packages update-package-database
        miktex --admin --verbose packages update
        miktex --admin --verbose fndb refresh
        initexmf --admin --verbose --set-config-value=[MPM]AutoInstall=1
        initexmf --admin --verbose --update-fndb
        initexmf --admin --verbose --mklinks --force
        updmap --admin

    - name: Setting Ghostscript paths (Windows)
      if: matrix.platform == 'windows'
      run: |
        export GSpath=`find /c/Prog*/gs -name gswin\*c.exe | sed -e "s/gswin.*c.exe//"`
        export PATH="$GSpath:$PATH"
        export GSpath=`echo "$GSpath" | sed -e "s%/c%C:%"`
        echo "$GSpath" >> $GITHUB_PATH
      shell: bash

    - name: Refresh Env (Windows)
      if: matrix.platform == 'windows'
      run: |
        Import-Module $env:ChocolateyInstall\helpers\chocolateyProfile.psm1
        refreshenv

    - name: Check tool versions (Windows)
      if: matrix.platform == 'windows'
      run: |
        echo "=== perl ===";
        perl --version;
        echo "=== python ===";
        python --version;
        echo "=== cmake ===";
        cmake --version;
        echo "=== latex ===";
        latex --version;
        echo "=== bibtex ===";
        bibtex --version
        echo "=== dvips ===";
        dvips --version
        echo "=== bison ===";
        win_bison --version;
        echo "=== flex ===";
        win_flex --version;
        echo "=== dot ===";
        dot -V;
        echo "=== ghostscript ===";
        gswin64c --version;
      shell: bash

#------------------------------------- setup macOS environment

    - name: Install dependencies (macOS)
      if: matrix.platform == 'macos'
      run: |
        brew install cmake ninja flex bison ossp-uuid
        # make sure flex and bison from brew are found and not the one from the system.
        echo "$(brew --prefix bison)/bin" >> $GITHUB_PATH
        echo "$(brew --prefix flex)/bin" >> $GITHUB_PATH
        echo "LOC=$(brew --prefix ossp-uuid)"
      shell: bash

#------------------------------------- install Visual Studio compiler

    - name: Set up MSVC dev command prompt (Windows)
      if: matrix.platform == 'windows'
      uses: ilammy/msvc-dev-cmd@v1

#------------------------------------- install HtmlHelp compiler for Windows

    - name: Download htmlhelp (Windows)
      if: matrix.platform == 'windows'
      run: |
        # curl -L -o windows/htmlhelp.exe http://web.archive.org/web/20160201063255/http://download.microsoft.com/download/0/A/9/0A939EF6-E31C-430F-A3DF-DFAE7960D564/htmlhelp.exe
        ./windows/htmlhelp.exe /VERYSILENT /SUPPRESSMSGBOXES /NORESTART
      shell: pwsh

    - name: Verify hhc.exe is installed
      if: matrix.platform == 'windows'
      shell: powershell
      run: |
          $possiblePaths = @(
            "$env:ProgramFiles(x86)\HTML Help Workshop\hhc.exe",
            "$env:ProgramFiles\HTML Help Workshop\hhc.exe",
            "$env:ProgramFiles(x86)\HTMLHelpWorkshop\hhc.exe",
            "$env:ProgramFiles\HTMLHelpWorkshop\hhc.exe"
          )

          # Find first existing file
          $installed = $possiblePaths | Where-Object { Test-Path $_ } | Select-Object -First 1

          # Fallback: on PATH
          if (-not $installed) {
            $cmd = Get-Command hhc.exe -ErrorAction SilentlyContinue
            if ($cmd) { $installed = $cmd.Path }
          }

          if (-not $installed) {
            Write-Error "hhc.exe not found in known locations or PATH."
            exit 1
          }

          Write-Host "hhc.exe found at: $installed"
          $fi = Get-Item $installed
          Write-Host "FileVersion: $($fi.VersionInfo.FileVersion)"
          Write-Host "ProductVersion: $($fi.VersionInfo.ProductVersion)"

#------------------------------------- get and install static libz for Windows

    - name: Download zlib (Windows)
      if: matrix.platform == 'windows'
      run: |
        curl -L -o zlib.tgz https://zlib.net/zlib-1.3.1.tar.gz
        tar zxvf zlib.tgz

    - name: Build zlib (Windows)
      if: matrix.platform == 'windows'
      shell: cmd
      run: |
        cd zlib-1.3.1
        @rem nmake -f win32\Makefile.msc LOC="-MT" all
        nmake -f win32\Makefile.msc LOC="-MT" zlib.lib

#------------------------------------- determine version of doxygen to use

    - name: Get latest Doxygen release tag
      id: doxygen-version
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -euo pipefail
        echo "GITHUB_TOKEN present: ${GITHUB_TOKEN:+yes}"
        # Retry loop with exponential backoff
        attempts=5
        sleep_for=2
        for i in $(seq 1 $attempts); do
          echo "Attempt $i..."
          resp=$(curl -sS -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github.v3+json" "https://api.github.com/repos/doxygen/doxygen/releases/latest" ) || true
          http_code=$(echo "$resp" | jq -r '. | if has("message") then "error" else "ok" end')
          tag=$(echo "$resp" | jq -r '.tag_name // empty')
          if [ -n "$tag" ]; then
            LATEST_TAG="$tag"
            break
          fi
          echo "No tag found. API response (truncated):"
          echo "$resp" | jq -C '.' | sed -n '1,200p'
          echo "Sleeping $sleep_for seconds before retry..."
          sleep $sleep_for
          sleep_for=$((sleep_for * 2))
        done

        if [ -z "${LATEST_TAG:-}" ]; then
          echo "Error: Could not fetch Doxygen release tag; last response:"
          echo "$resp" | jq -C '.' || echo "$resp"
          exit 1
        fi

        echo "Latest Doxygen release: $LATEST_TAG"
        echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT
        # Remove leading 'Release_' prefix if present
        VERSION=${LATEST_TAG#Release_}
        VERSION=${VERSION//_/.}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
      shell: bash

#------------------------------------- download Doxygen sources

    - name: Download Doxygen source code
      #if: steps.cache-doxygen-source.outputs.cache-hit != 'true'
      run: |
        echo "Downloading Doxygen ${{ steps.doxygen-version.outputs.tag }}"

        # download specific tag
        #git clone --depth 1 --branch ${{ steps.doxygen-version.outputs.tag }} https://github.com/doxygen/doxygen.git

        # alternatively use latest master
        git clone --depth 1 --branch master https://github.com/doxygen/doxygen.git

        if [ ! -d "doxygen" ]; then
          echo "Error: Doxygen source download failed or directory structure is incorrect"
          exit 1
        fi
        echo "Doxygen source downloaded successfully"
      shell: bash

#------------------------------------- prepare libclang dependency

    - name: Download LLVM artifacts
      uses: dawidd6/action-download-artifact@v11
      with:
        workflow: build-llvm.yml
        name: llvm-static-.*-${{ matrix.os }}
        name_is_regexp: true
        path: llvm-artifact
        skip_unpack: false

    - name: Extract LLVM version from artifact
      id: llvm-version
      run: |
        cd llvm-artifact
        FILENAME=$(ls llvm-static-* | head -1)
        VERSION=$(echo "$FILENAME" | sed -E 's/llvm-static-(.+)-${{ matrix.os }}.*/\1/')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "LLVM version from artifact: $VERSION"
      shell: bash

    - name: Extract LLVM artifacts (Linux/macOS)
      if: matrix.platform != 'windows'
      run: |
        mkdir -p llvm-install
        cd llvm-artifact/llvm-static-${{ steps.llvm-version.outputs.version }}-${{ matrix.os }}
        # Extract the tar.gz archive to the install directory
        tar -xzf llvm-static-${{ steps.llvm-version.outputs.version }}-${{ matrix.os }}.tar.gz -C ../../llvm-install
      shell: bash

    - name: Extract LLVM artifacts (Windows)
      if: matrix.platform == 'windows'
      run: |
        mkdir llvm-install
        dir
        cd llvm-artifact\llvm-static-${{ steps.llvm-version.outputs.version }}-${{ matrix.os }}
        dir
        # Extract the zip archive to the install directory
        Expand-Archive -Path "llvm-static-${{ steps.llvm-version.outputs.version }}-${{ matrix.os }}.zip" -DestinationPath "../../llvm-install"
      shell: pwsh

#------------------------------------- prepare Qt dependency

    - name: Download Qt6 artifacts
      uses: dawidd6/action-download-artifact@v11
      with:
        workflow: build-qt6.yml
        name: qt6-static-.*-${{ matrix.os }}
        name_is_regexp: true
        path: qt6-artifact
        skip_unpack: false

    - name: Extract Qt6 version from artifact
      id: qt6-version
      run: |
        cd qt6-artifact
        FILENAME=$(ls qt6-static-* | head -1)
        VERSION=$(echo "$FILENAME" | sed -E 's/qt6-static-(.+)-${{ matrix.os }}.*/\1/')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Qt6 version from artifact: $VERSION"
      shell: bash

    - name: Extract Qt6 artifacts (Linux/macOS)
      if: matrix.platform != 'windows'
      run: |
        mkdir -p qt6-install
        cd qt6-artifact/qt6-static-${{ steps.qt6-version.outputs.version }}-${{ matrix.os }}
        # Extract the tar.gz archive to the install directory
        tar -xzf qt6-static-${{ steps.qt6-version.outputs.version }}-${{ matrix.os }}.tar.gz -C ../../qt6-install
      shell: bash

    - name: Extract Qt6 artifacts (Windows)
      if: matrix.platform == 'windows'
      run: |
        mkdir qt6-install
        cd qt6-artifact\qt6-static-${{ steps.qt6-version.outputs.version }}-${{ matrix.os }}
        # Extract the zip archive to the install directory
        Expand-Archive -Path "qt6-static-${{ steps.qt6-version.outputs.version }}-${{ matrix.os }}.zip" -DestinationPath "../../qt6-install"
      shell: pwsh

#------------------------------------- prepare Xapian dependency

    - name: Download Xapian artifacts
      uses: dawidd6/action-download-artifact@v11
      with:
        workflow: build-xapian.yml
        name: xapian-static-.*-${{ matrix.os }}
        name_is_regexp: true
        path: xapian-artifact
        skip_unpack: false

    - name: Extract Xapian version from artifact
      id: xapian-version
      run: |
        cd xapian-artifact
        FILENAME=$(ls xapian-static-* | head -1)
        VERSION=$(echo "$FILENAME" | sed -E 's/xapian-static-(.+)-${{ matrix.os }}.*/\1/')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Xapian version from artifact: $VERSION"
      shell: bash

    - name: Extract Xapian artifacts (Linux/macOS)
      if: matrix.platform != 'windows'
      run: |
        mkdir -p xapian-install
        cd xapian-artifact/xapian-static-${{ steps.xapian-version.outputs.version }}-${{ matrix.os }}
        # Extract the tar.gz archive to the install directory
        tar -xzf xapian-static-${{ steps.xapian-version.outputs.version }}-${{ matrix.os }}.tar.gz -C ../../xapian-install
      shell: bash

    - name: Extract Xapian artifacts (Windows)
      if: matrix.platform == 'windows'
      run: |
        mkdir xapian-install
        cd xapian-artifact\xapian-static-${{ steps.xapian-version.outputs.version }}-${{ matrix.os }}
        # Extract the zip archive to the install directory
        Expand-Archive -Path "xapian-static-${{ steps.xapian-version.outputs.version }}-${{ matrix.os }}.zip" -DestinationPath "../../xapian-install"
      shell: pwsh

#------------------------------------- configure build

    - name: Configure CMake for Doxygen (Linux)
      if: matrix.platform == 'linux'
      run: |
        mkdir -p doxygen/build
        cd doxygen/build
        UUID_FLAG="-DUUID_LIB=/lib/x86_64-linux-gnu/libuuid.a"
        echo "UUID_FLAG=$UUID_FLAG"
        cmake .. -G "Unix Makefiles" \
          -DCMAKE_BUILD_TYPE="${{ env.BUILD_TYPE }}" \
          -DCMAKE_INSTALL_PREFIX="${{ github.workspace }}/doxygen-install" \
          -DXAPIAN_LIBRARIES="${{ github.workspace }}/xapian-install/lib/libxapian.a" \
          -DXAPIAN_INCLUDE_DIR="${{ github.workspace }}/xapian-install/include" \
          -DXAPIAN_DIR="${{ github.workspace }}/xapian-install/lib/cmake/xapian" $UUID_FLAG \
          -DLLVM_DIR="${{ github.workspace }}/llvm-install/lib/cmake/llvm" \
          -DClang_DIR="${{ github.workspace }}/llvm-install/lib/cmake/clang" \
          -DQt6_DIR="${{ github.workspace }}/qt6-install/lib/cmake/Qt6" \
          -DQt6Core_DIR="${{ github.workspace }}/qt6-install/lib/cmake/Qt6Core" \
          -DQt6Gui_DIR="${{ github.workspace }}/qt6-install/lib/cmake/Qt6Gui" \
          -DQt6Widgets_DIR="${{ github.workspace }}/qt6-install/lib/cmake/Qt6Widgets" \
          -Dbuild_doc=YES \
          -Dbuild_search=YES \
          -Dbuild_wizard=YES \
          -Duse_libclang=YES \
          -Dstatic_libclang=YES \
          -Dstatic_libxapian=YES \
          -Dforce_qt=Qt6 \
          -DCMAKE_PREFIX_PATH="${{ github.workspace }}/llvm-install;${{ github.workspace }}/qt6-install;${{ github.workspace }}/xapian-install"
      shell: bash


    - name: Configure CMake for Doxygen (macOS)
      if: matrix.platform == 'macos'
      run: |
        mkdir -p doxygen/build
        cd doxygen/build
        UUID_FLAG="-DUUID_LIB=$(brew --prefix ossp-uuid)/lib/libuuid.a"
        echo "UUID_FLAG=$UUID_FLAG"
        cmake .. -G "Unix Makefiles" \
          -DCMAKE_BUILD_TYPE="${{ env.BUILD_TYPE }}" \
          -DCMAKE_INSTALL_PREFIX="${{ github.workspace }}/doxygen-install" \
          -DXAPIAN_LIBRARIES="${{ github.workspace }}/xapian-install/lib/libxapian.a" \
          -DXAPIAN_INCLUDE_DIR="${{ github.workspace }}/xapian-install/include" \
          -DXAPIAN_DIR="${{ github.workspace }}/xapian-install/lib/cmake/xapian" $UUID_FLAG \
          -DLLVM_DIR="${{ github.workspace }}/llvm-install/lib/cmake/llvm" \
          -DClang_DIR="${{ github.workspace }}/llvm-install/lib/cmake/clang" \
          -DQt6_DIR="${{ github.workspace }}/qt6-install/lib/cmake/Qt6" \
          -DQt6Core_DIR="${{ github.workspace }}/qt6-install/lib/cmake/Qt6Core" \
          -DQt6Gui_DIR="${{ github.workspace }}/qt6-install/lib/cmake/Qt6Gui" \
          -DQt6Widgets_DIR="${{ github.workspace }}/qt6-install/lib/cmake/Qt6Widgets" \
          -Dbuild_search=YES \
          -Dbuild_wizard=YES \
          -Duse_libclang=YES \
          -Dstatic_libclang=YES \
          -Dstatic_libxapian=YES \
          -Dforce_qt=Qt6 \
          -DCMAKE_PREFIX_PATH="${{ github.workspace }}/llvm-install;${{ github.workspace }}/qt6-install;${{ github.workspace }}/xapian-install"
      shell: bash

    - name: Configure CMake for Doxygen (Windows)
      if: matrix.platform == 'windows'
      run: |
        mkdir doxygen\build
        cd doxygen\build
        cmake .. -G "Ninja" -Dwin_static=YES -Dbuild_search=YES -Dbuild_wizard=YES -Duse_libclang=YES -Dstatic_libclang=YES -Dforce_qt=Qt6 -Dbuild_doc=YES -Dbuild_doc_chm=YES ^
              -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} ^
              -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}\doxygen-install ^
              -DXAPIAN_LIBRARIES=${{ github.workspace }}\xapian-install\lib\xapian.lib ^
              -DXAPIAN_INCLUDE_DIR=${{ github.workspace }}\xapian-install\include ^
              -DXAPIAN_DIR=${{ github.workspace }}\xapian-install\lib\cmake\xapian ^
              -DLLVM_DIR=${{ github.workspace }}\llvm-install\lib\cmake\llvm ^
              -DClang_DIR=${{ github.workspace }}\llvm-install\lib\cmake\clang ^
              -DCLANG_LIBS=${{ github.workspace }}\llvm-install\lib\libclang.lib ^
              -DQt6_DIR=${{ github.workspace }}\qt6-install\lib\cmake\Qt6 ^
              -DQt6Core_DIR=${{ github.workspace }}\qt6-install\lib\cmake\Qt6Core ^
              -DQt6Gui_DIR=${{ github.workspace }}\qt6-install\lib\cmake\Qt6Gui ^
              -DQt6Widgets_DIR=${{ github.workspace }}\qt6-install\lib\cmake\Qt6Widgets ^
              -DZLIB_LIBRARY=${{ github.workspace }}\zlib-1.3.1\zlib.lib ^
              -DZLIB_INCLUDE_DIR=${{ github.workspace }}\zlib-1.3.1\include
      shell: cmd

#------------------------------------- build targets

    - name: Build Doxygen (Linux)
      if: matrix.platform == 'linux'
      run: |
        cd doxygen/build
        make -j$(nproc)
        make docs
        make install
      shell: bash

    - name: Build Doxygen (macOS)
      if: matrix.platform == 'macos'
      run: |
        cd doxygen/build
        cmake --build . --parallel 2
      shell: bash

    - name: Build Doxygen (Windows)
      if: matrix.platform == 'windows'
      run: |
        cd doxygen\build
        cmake --build . --parallel
      shell: cmd

    - name: Build Doxygen docs (Windows)
      if: matrix.platform == 'windows'
      run: |
        cd doxygen\build
        cmake --build . --parallel 1 --target docs
        cmake --build . --parallel 1 --target docs_chm
      shell: cmd

    - name: Install Doxygen (Windows)
      if: matrix.platform == 'windows'
      run: |
        cd doxygen\build
        cmake --install .
      shell: cmd

#------------------------------------- verify build results

    - name: Verify Doxygen build (Linux)
      if: matrix.platform == 'linux'
      run: |
        echo "Checking Doxygen binary..."
        ls -lh ${{ github.workspace }}/doxygen-install/bin/doxygen${{ matrix.extension }}
        # Try to run doxygen to verify it works
        ${{ github.workspace }}/doxygen-install/bin/doxygen${{ matrix.extension }} --version || echo "Note: doxygen version check failed (may be expected on some platforms)"
      shell: bash

    - name: Verify Doxygen build (Windows)
      if: matrix.platform == 'windows'
      run: |
        echo "Checking Doxygen binary..."
        ls -lh ${{ github.workspace }}\doxygen-install\bin\doxygen${{ matrix.extension }}
        ${{ github.workspace }}\doxygen-install\bin\doxygen${{ matrix.extension }} --version || echo "Note: doxygen version check failed (may be expected on some platforms)"
      shell: cmd

#------------------------------------- create installation artifacts

    - name: Create installer (Windows)
      if: matrix.platform == 'windows'
      run: |
        subst R: ${{ github.workspace }}
        mkdir installer
        copy R:\llvm-install\bin\libclang.dll ${{ github.workspace }}\doxygen-install\bin
        editbin R:\doxygen-install\bin\doxygen.exe /SUBSYSTEM:CONSOLE,6.00 /OSVERSION:5.1
        editbin R:\doxygen-install\bin\doxyindexer.exe /SUBSYSTEM:CONSOLE,6.00 /OSVERSION:5.1
        editbin R:\doxygen-install\bin\doxysearch.cgi.exe /SUBSYSTEM:CONSOLE,6.00 /OSVERSION:5.1
        Write-Host "Using version: '${{ steps.doxygen-version.outputs.version }}'"
        (Get-Content .\windows\doxygen.iss -Raw) -replace '\$VERSION','${{ steps.doxygen-version.outputs.version }}' | Set-Content -Encoding ASCII .\doxygen-versioned.iss
        # invoke the inno setup compiler
        $iscc = Get-Command ISCC.exe -ErrorAction SilentlyContinue
        if (-not $iscc) {
          Write-Error "ISCC.exe not found. Checked: $($possible -join '; ') and PATH."
          exit 1
        }
        & iscc 'doxygen-versioned.iss'
        if ($LASTEXITCODE -ne 0) { Write-Error "ISCC failed with exit code $LASTEXITCODE"; exit $LASTEXITCODE }
        $doxygen_chm_files = @(
          'R:\doxygen-install\share\doc\packages\doxygen\doxygen_manual.chm'
        )
        Compress-Archive -Path $doxygen_chm_files -DestinationPath 'R:\installer\doxygen_manual-${{ steps.doxygen-version.outputs.version }}.chm.zip' -Force
        $doxygen_zip_files = @(
          'R:\doxygen-install\bin\doxysearch.cgi.exe',
          'R:\doxygen-install\bin\doxyindexer.exe',
          'R:\doxygen-install\bin\doxywizard.exe'
          'R:\doxygen-install\bin\doxygen.exe'
          'R:\doxygen-install\bin\libclang.dll'
        )
        Compress-Archive -Path $doxygen_zip_files -DestinationPath 'R:\installer\doxygen-${{ steps.doxygen-version.outputs.version }}.x64.bin.zip' -Force
      shell: powershell

    - name: Create installer (macOS)
      if: matrix.platform == 'macos'
      run: |
        mkdir installer

        # create DMG file
        mkdir image
        bunzip2 -k macosx/template.sparseimage.bz2
        hdiutil attach macosx/template.sparseimage -noautoopen -quiet -mountpoint image
        cp -a macosx/Doxygen.app image
        cp -a macosx/Readme.rtf image
        mkdir -p image/Doxygen.app/Contents/MacOS
        sed -i -e "s/\$VERSION/${{ steps.doxygen-version.outputs.version }}/g" image/Doxygen.app/Contents/Info.plist
        cp doxygen/build/bin/doxygen        image/Doxygen.app/Contents/Resources
        cp doxygen/build/bin/doxyindexer    image/Doxygen.app/Contents/Resources
        cp doxygen/build/bin/doxysearch.cgi image/Doxygen.app/Contents/Resources
        cp doxygen/build/bin/doxywizard     image/Doxygen.app/Contents/MacOS/Doxywizard
        /usr/sbin/diskutil rename image Doxygen
        hdiutil detach image
        hdiutil convert -format UDCO -o installer/Doxygen-${{ steps.doxygen-version.outputs.version }}-${{ matrix.cpu }}.dmg macosx/template.sparseimage
        xattr -c installer/Doxygen-${{ steps.doxygen-version.outputs.version }}-${{ matrix.cpu }}.dmg

        # create zip with binaries
        mkdir -p doxygen-${{ steps.doxygen-version.outputs.version }}
        cp doxygen/build/bin/doxygen        doxygen-${{ steps.doxygen-version.outputs.version }}
        cp doxygen/build/bin/doxyindexer    doxygen-${{ steps.doxygen-version.outputs.version }}
        cp doxygen/build/bin/doxysearch.cgi doxygen-${{ steps.doxygen-version.outputs.version }}
        zip -r installer/doxygen-${{ steps.doxygen-version.outputs.version }}-mac-${{ matrix.cpu }}.zip doxygen-${{ steps.doxygen-version.outputs.version }}
        
      shell: bash

    - name: Create installer (Linux)
      if: matrix.platform == 'linux'
      run: |
        VERSION=${{ steps.doxygen-version.outputs.version }}

        # create installer dir
        mkdir -p installer

        # create source package
        tar -C doxygen --exclude bin -c -v -f installer/doxygen-$VERSION.src.tar.gz \
          doc doc_internal deps vhdlparser libxml libversion examples addon src testing templates cmake \
          CMakeLists.txt BUILD.txt INSTALL LANGUAGE.HOWTO LICENSE README.md

        # create PDF version of the manual
        cp doxygen/build/latex/doxygen_manual.pdf installer/doxygen_manual-$VERSION.pdf
        cd installer
        zip -m doxygen_manual-$VERSION.pdf.zip doxygen_manual-$VERSION.pdf
        cd ..

        # create binary package for Linux
        DESTDIR=package/doxygen-$VERSION
        mkdir -p $DESTDIR
        cat linux/README.bin | sed -e "s/\$VERSION/$VERSION/g" -e "s/\$DATE/`date +\"%d %B %Y\"`/g" >$DESTDIR/README
        cp doxygen/LICENSE $DESTDIR
        cp linux/Makefile.bin.in $DESTDIR/Makefile
        cat doxygen/INSTALL | sed -e "s/\$VERSION/$VERSION/g" -e "s/\$DATE/`date +\"%d %B %Y\"`/g" >$DESTDIR/INSTALL
        mkdir $DESTDIR/bin
        mkdir -p $DESTDIR/man/man1
        cp -a doxygen/build/html $DESTDIR
        cp -a doxygen/build/examples $DESTDIR
        cp doxygen/build/bin/doxygen $DESTDIR/bin
        cp doxygen/build/latex/doxygen_manual.pdf $DESTDIR/doxygen_manual-$VERSION.pdf
        cp doxygen/build/bin/doxyindexer $DESTDIR/bin
        cp doxygen/build/bin/doxysearch.cgi $DESTDIR/bin
        cp doxygen/build/bin/doxywizard $DESTDIR/bin
        cp doxygen/build/man/*.1 $DESTDIR/man/man1
        gzip $DESTDIR/man/man1/*
        tar -C package -z -c -v -f installer/doxygen-$VERSION.linux.bin.tar.gz doxygen-$VERSION
      shell: bash

#------------------------------------- upload individual artifacts

    - name: Upload Doxygen build (Windows/setup.exe)
      if: matrix.platform == 'windows'
      uses: actions/upload-artifact@v4
      with:
        name: doxygen-${{ steps.doxygen-version.outputs.version }}-setup.exe
        path: installer/doxygen-${{ steps.doxygen-version.outputs.version }}-setup.exe

    - name: Upload Doxygen build (Windows/doxygen-x64.zip)
      if: matrix.platform == 'windows'
      uses: actions/upload-artifact@v4
      with:
        name: doxygen-${{ steps.doxygen-version.outputs.version }}.x64.bin.zip
        path: installer/doxygen-${{ steps.doxygen-version.outputs.version }}.x64.bin.zip

    - name: Upload Doxygen build (Windows/doxygen_manual.chm)
      if: matrix.platform == 'windows'
      uses: actions/upload-artifact@v4
      with:
        name: doxygen_manual-${{ steps.doxygen-version.outputs.version }}.chm.zip
        path: installer/doxygen_manual-${{ steps.doxygen-version.outputs.version }}.chm.zip

    - name: Upload Doxygen build (macOS/doxygen.dmg)
      if: matrix.platform == 'macos'
      uses: actions/upload-artifact@v4
      with:
        name: Doxygen-${{ steps.doxygen-version.outputs.version }}-${{ matrix.cpu }}.dmg
        path: installer/Doxygen-${{ steps.doxygen-version.outputs.version }}-${{ matrix.cpu }}.dmg

    - name: Upload Doxygen build (macOS/doxygen-mac.zip)
      if: matrix.platform == 'macos'
      uses: actions/upload-artifact@v4
      with:
        name: doxygen-${{ steps.doxygen-version.outputs.version }}-mac-${{ matrix.cpu }}.zip
        path: installer/doxygen-${{ steps.doxygen-version.outputs.version }}-mac-${{ matrix.cpu }}.zip

    - name: Upload Doxygen build (Linux/doxygen.src.tar.gz)
      if: matrix.platform == 'linux'
      uses: actions/upload-artifact@v4
      with:
        name: doxygen-${{ steps.doxygen-version.outputs.version }}.src.tar.gz
        path: installer/doxygen-${{ steps.doxygen-version.outputs.version }}.src.tar.gz

    - name: Upload Doxygen build (Linux/doxygen.linux.bin.tar.gz)
      if: matrix.platform == 'linux'
      uses: actions/upload-artifact@v4
      with:
        name: doxygen-${{ steps.doxygen-version.outputs.version }}.linux.bin.tar.gz
        path: installer/doxygen-${{ steps.doxygen-version.outputs.version }}.linux.bin.tar.gz

    - name: Upload Doxygen build (Linux/doxygen_manual.pdf.zip)
      if: matrix.platform == 'linux'
      uses: actions/upload-artifact@v4
      with:
        name: doxygen_manual-${{ steps.doxygen-version.outputs.version }}.pdf.zip
        path: installer/doxygen_manual-${{ steps.doxygen-version.outputs.version }}.pdf.zip

